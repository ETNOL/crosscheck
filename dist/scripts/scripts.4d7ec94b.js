"use strict";var app=angular.module("crossCheckApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]).constant("FIREBASE_URL","https://amber-fire-3032.firebaseio.com/");app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/login.html",controller:"AuthCtrl"}).when("/list/:listid",{templateUrl:" views/list.html",controller:"ListCtrl"}).when("/lists",{templateUrl:"views/lists.html",controller:"ListsCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl"}).otherwise({redirectTo:"/"})}]),app.controller("AuthCtrl",["$location","$scope","$rootScope","Auth","User",function(a,b,c,d,e){e.signedIn()&&a.path("/lists"),b.login=function(){d.login(b.user),a.path("/lists")},b.register=function(){d.register(b.user).then(function(a){e.create(a,b.user.username)}).then(function(){a.path("/login")},function(a){b.error=a.toString()})}}]),app.controller("ListCtrl",["Team","List","$routeParams","$scope","User","$firebase","FIREBASE_URL",function(a,b,c,d,e,f,g){function h(){e.getCurrent().then(function(){var e=new Firebase(g+"/lists");b.object=f(e.child(c.listid)).$asObject(),b.items=f(e.child(c.listid).child("items")).$asArray(),a.members=f(e.child(c.listid).child("members")).$asArray(),d.items=b.items,d.team=a.members})}function i(){return{item:d.item.description,checks:0}}d.items,d.team,d.checksAsArray=function(a){return b.checksAsArray(a)},d.checks=function(a){return b.checks(a)},d.checkItem=function(a){b.check(a)},d.addItem=function(){b.add(i()),d.item.description=""},d.resetList=function(){confirm("Are you sure you want to reset the list?")&&b.resetList()},h()}]),app.controller("ListsCtrl",["$scope","$firebase","FIREBASE_URL","$location","User",function(a,b,c,d,e){function f(){e.getCurrent().then(function(a){console.log(a),h(a);var b=e.findByEmail(a.email);b.$loaded(function(){g(b[0].$id)})})}function g(c){a.lists=b(k.child(c).child("lists")).$asArray()}function h(b){a.user=b}function i(){return{listName:a.newList.listName,members:{owner:a.user}}}var j=new Firebase(c+"/lists"),k=new Firebase(c+"/crossCheckUsers");a.lists,a.user,a.loadList=function(a){d.path("list/"+a.$id)},a.newList=function(){var c=b(j).$asArray(),d=i();c.$add(d).then(function(b){var c=b.name(),d=a.newList.listName;e.addList(c,d),a.newList.listName=""})},f()}]),app.controller("NavCtrl",["$location","$scope","User","Auth",function(a,b,c,d){b.user=c.getCurrent(),b.signedIn=function(){return c.signedIn()},b.home=function(){a.path("/")},b.logout=function(){d.logout()}}]),app.controller("TeamCtrl",["$scope","Team","User",function(a,b,c){a.team,a.openTeamMenu=!1,a.teamMenu=function(){return a.openTeamMenu},a.toggleTeamMenu=function(){a.openTeamMenu=!a.openTeamMenu},a.addMember=function(){var d=c.findByEmail(a.newMember.email);d.$loaded(function(){var c=d[0];return void 0==c?(a.notificationStyle="bg-danger",a.notification="Crosscheck member not found!"):(b.add(c),a.notificationStyle="bg-success",a.notification="Team member added!",void(a.newMember.email=""))})}}]),app.factory("List",["$rootScope","User","$firebase","FIREBASE_URL",function(a){var b={object:{},items:[],add:function(a){this.items.$add(a)},remove:function(a){this.items.$remove(a)},check:function(b){var c=a.currentUser.id,d=[];if(this.items[b].checks)for(var e=0;e<this.items[b].checks.length;e++)d.push(this.items[b].checks[e]);if(0==d.length)this.items[b].checks={0:c};else if(-1==d.indexOf(c))this.items[b].checks[d.length]=c;else{var f=d.indexOf(c);this.items[b].checks.splice(f,1)}this.items.$save(b)},checks:function(a){return this.items[a].checks?this.items[a].checks.length:0},resetList:function(){console.log("reset called!");for(var a=0;a<this.items.length;a++)this.items[a].checks=0,this.items.$save(a)},checksAsArray:function(a){for(var b=[],c=0;c<this.checks(a);c++)b.push(c);return b}};return b}]),app.factory("Team",["List","User","FIREBASE_URL",function(a,b){var c={members:[],add:function(c){var d={email:c.email,id:c.id,username:c.$id};this.members.$add(d),b.addList(a.object.$id,a.object.listName,c.email)}};return c}]),app.factory("User",["$rootScope","$q","$firebase","FIREBASE_URL",function(a,b,c,d){var e=new Firebase(d+"crossCheckUsers"),f={create:function(a,b){var d=c(e.child(b)).$asObject();return d.$loaded(function(){d.lists="0",d.email=a.email,d.id=a.id,d.$priority=a.email,d.$save()})},findByEmail:function(a){return c(e.startAt(a).endAt(a)).$asArray()},setCurrent:function(b){a.currentUser=b},getCurrent:function(){var c=b.defer();return setTimeout(function(){c.notify("fetching user..."),a.currentUser?c.resolve(a.currentUser):c.reject("User read failure")},1500),c.promise},signedIn:function(){return void 0!==a.currentUser},addList:function(a,b,d){var f=d||this.user.email,g=this.findByEmail(f);g.$loaded(function(d){var f=d[0].$id,g=c(e.child(f).child("lists").child(a)).$asObject();g.$loaded(function(){g.name=b,g.$save()})})}};return a.$on("$firebaseSimpleLogin:login",function(a,b){f.setCurrent(b)}),a.$on("$firebaseSimpleLogin:logout",function(){delete a.currentUser,delete a.userLists,delete a.listId}),f}]),app.factory("Auth",["User","$location","$rootScope","$firebaseSimpleLogin","FIREBASE_URL",function(a,b,c,d,e){var f=new Firebase(e),g=d(f),h={register:function(a){return g.$createUser(a.email,a.password)},login:function(a){a.rememberMe="true",g.$login("password",a).then(function(){b.path("/lists")},function(a){console.log(a)})},signedIn:function(){return null!==g.user},logout:function(){g.$logout(),b.path("/"),delete c.currentUser,delete c.userLists,delete c.listId}};return c.signedIn=function(){return h.signedIn()},h}]);