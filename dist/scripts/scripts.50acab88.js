"use strict";var app=angular.module("crossCheckApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase"]).constant("FIREBASE_URL","https://amber-fire-3032.firebaseio.com/");app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/login.html",controller:"AuthCtrl"}).when("/list/:listid",{templateUrl:" views/list.html",controller:"ListCtrl"}).when("/lists",{templateUrl:"views/lists.html",controller:"ListsCtrl"}).when("/register",{templateUrl:"views/register.html",controller:"AuthCtrl"}).otherwise({redirectTo:"/"})}]),app.controller("AuthCtrl",["$location","$scope","$rootScope","Auth","User",function(a,b,c,d,e){e.signedIn()&&a.path("/lists"),b.login=function(){d.login(b.user),a.path("/lists")},b.register=function(){d.register(b.user).then(function(a){e.create(a,b.user.username)}).then(function(){a.path("/login")},function(a){b.error=a.toString()})}}]),app.controller("ListCtrl",["Team","List","$routeParams","$scope","User","$firebase","FIREBASE_URL",function(a,b,c,d,e,f,g){function h(){e.getCurrent().then(function(){b.object=f(i.child(c.listid)).$asObject(),b.items=f(i.child(c.listid).child("items")).$asArray(),a.members=f(i.child(c.listid).child("members")).$asArray(),d.items=b.items,d.team=a.members})}var i=new Firebase(g+"/lists");d.items,d.team,d.totalChecks=function(a){for(var c=[],d=0;d<b.checks(a);d++)c.push(d);return c},d.checks=function(a){return b.checks(a)},d.checkItem=function(a){b.check(a)},d.addItem=function(){b.add({item:d.item.description,checks:0}),d.item={description:""}},d.checked=function(a){return 1==a.checks?!0:void 0},d.resetList=function(){var a=confirm("Are you sure you want to reset the list?");a&&b.resetList()},d.openTeamMenu=!1,d.teamMenu=function(){return d.openTeamMenu},d.toggleTeamMenu=function(){d.openTeamMenu=!d.openTeamMenu},h()}]),app.controller("ListsCtrl",["$scope","$rootScope","$firebase","FIREBASE_URL","$location","User",function(a,b,c,d,e,f){function g(){f.getCurrent().then(function(a){var b=f.findByEmail(a.email);b.$loaded(function(){h(b[0].$id)})})}function h(b){a.lists=c(j.child(b).child("lists")).$asArray(),console.log(a.lists)}var i=new Firebase(d+"/lists"),j=new Firebase(d+"/crossCheckUsers");a.lists,a.loadList=function(a){e.path("list/"+a.$id)},a.newList=function(){var d=(b.currentUser.id,c(i).$asArray()),e={listName:a.newList.listName,members:{owner:b.currentUser}};d.$add(e).then(function(b){var c=b.name(),d=a.newList.listName;f.addList(c,d),a.newList.listName=""})},g()}]),app.controller("NavCtrl",["$location","$scope","User","Auth",function(a,b,c,d){b.user=c.getCurrent(),b.signedIn=function(){return c.signedIn()},b.home=function(){a.path("/")},b.logout=function(){d.logout()}}]),app.controller("TeamCtrl",["$scope","Team","User",function(a,b,c){a.team,a.addMember=function(){var d=c.findByEmail(a.newMember.email);d.$loaded(function(){var c=d[0];b.add(c),a.newMember.email=""})}}]),app.factory("List",["User","$rootScope","$firebase","FIREBASE_URL",function(a,b){var c={object:{},items:[],add:function(a){this.items.$add(a)},remove:function(a){this.items.$remove(a)},check:function(a){var c=b.currentUser.id,d=[];if(this.items[a].checks)for(var e=0;e<this.items[a].checks.length;e++)d.push(this.items[a].checks[e]);if(0==d.length)this.items[a].checks={0:c};else if(-1==d.indexOf(c))this.items[a].checks[d.length]=c;else{var f=d.indexOf(c);this.items[a].checks.splice(f,1)}this.items.$save(a)},checks:function(a){return this.items[a].checks?this.items[a].checks.length:0},resetList:function(){console.log("reset called!");for(var a=0;a<this.items.length;a++)this.items[a].checks=0,this.items.$save(a)}};return c}]),app.factory("Team",["List","User","FIREBASE_URL",function(a,b){var c={members:[],add:function(c){var d={email:c.email,id:c.id,username:c.$id};this.members.$add(d),b.addList(a.object.$id,a.object.listName,c.email)}};return c}]),app.factory("User",["$rootScope","$q","$firebase","FIREBASE_URL",function(a,b,c,d){function e(a){g.setCurrent(a)}var f=new Firebase(d+"crossCheckUsers"),g={create:function(a,b){var d=c(f.child(b)).$asObject();return d.$loaded(function(){d.lists="0",d.email=a.email,d.id=a.id,d.$priority=a.email,d.$save()})},findByEmail:function(a){return c(f.startAt(a).endAt(a)).$asArray()},setCurrent:function(b){a.currentUser=b},getCurrent:function(){var c=b.defer();return setTimeout(function(){c.notify("fetching user..."),void 0!=a.currentUser?c.resolve(a.currentUser):c.reject("User read failure")},1e3),c.promise},signedIn:function(){return void 0!==a.currentUser},addList:function(b,d,e){var g=e||a.currentUser.email,h=this.findByEmail(g);h.$loaded(function(a){var e=a[0].$id,g=c(f.child(e).child("lists").child(b)).$asObject();g.$loaded(function(){console.log(g),g.name=d,g.$save()})})}};return a.$on("$firebaseSimpleLogin:login",function(a,b){e(b)}),a.$on("$firebaseSimpleLogin:logout",function(){delete a.currentUser,delete a.userLists,delete a.listId}),g}]),app.factory("Auth",["User","$location","$rootScope","$firebaseSimpleLogin","FIREBASE_URL",function(a,b,c,d,e){var f=new Firebase(e),g=d(f),h={register:function(a){return g.$createUser(a.email,a.password)},login:function(a){a.rememberMe="true",g.$login("password",a).then(function(){b.path("/lists")},function(a){console.log(a)})},signedIn:function(){return null!==g.user},logout:function(){g.$logout(),b.path("/"),delete c.currentUser,delete c.userLists,delete c.listId}};return c.signedIn=function(){return h.signedIn()},h}]);